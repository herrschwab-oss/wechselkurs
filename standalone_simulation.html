<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wechselkurs Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --demand-color: #f472b6;
            --supply-color: #34d399;
            --border-color: rgba(148, 163, 184, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --success-color: #4ade80;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            max-height: 850px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        header {
            text-align: center;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .rate-display-header {
            background: rgba(15, 23, 42, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            border: var(--glass-border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .rate-display-header .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .rate-display-header .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        main {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1rem;
            flex-grow: 1;
            min-height: 0;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .display-area {
            position: relative;
            padding: 1rem;
        }

        .chart-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .controls-area {
            gap: 1rem;
            padding: 1.25rem;
            overflow-y: auto;
        }

        /* Compact Task Panel */
        .task-panel {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(56, 189, 248, 0.2);
            flex-shrink: 0;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .task-header h3 {
            font-size: 0.85rem;
            color: var(--accent-primary);
            text-transform: uppercase;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.4rem;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: inherit;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .task-text {
            font-size: 0.85rem;
            line-height: 1.35;
            margin-bottom: 0.5rem;
            font-weight: 500;
            min-height: 3em;
        }

        .task-feedback {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.4rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .task-feedback.visible {
            display: block;
        }

        .task-feedback.success {
            border-left: 2px solid var(--success-color);
            background: rgba(74, 222, 128, 0.1);
        }

        .task-feedback strong {
            display: block;
            margin-bottom: 0.1rem;
        }

        .control-group h2 {
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        .demand-group h2 {
            color: var(--demand-color);
        }

        .supply-group h2 {
            color: var(--supply-color);
        }

        .control-group p {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .slider-container label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: var(--text-primary);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 3px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .demand-group input[type=range]::-webkit-slider-thumb {
            background: var(--demand-color);
            box-shadow: 0 0 10px var(--demand-color);
        }

        .supply-group input[type=range]::-webkit-slider-thumb {
            background: var(--supply-color);
            box-shadow: 0 0 10px var(--supply-color);
        }

        .info-box {
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 0.75rem;
            border-left: 3px solid var(--text-secondary);
            margin-top: auto;
            font-size: 0.8rem;
        }

        .info-box h3 {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .info-box p {
            line-height: 1.3;
            color: var(--text-secondary);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 900px) {
            body {
                overflow: auto;
                height: auto;
                display: block;
            }

            .app-container {
                height: auto;
                max-height: none;
                padding: 1rem;
            }

            header {
                flex-direction: column;
                gap: 1rem;
            }

            main {
                grid-template-columns: 1fr;
            }

            .display-area {
                min-height: 350px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header>
            <div>
                <h1>Wechselkurs Marktmodell</h1>
                <p style="font-size: 0.9rem">Simulieren Sie Ceteris Paribus Szenarien</p>
            </div>
            <div class="rate-display-header">
                <span class="label">Aktueller Kurs:</span>
                <span class="value" id="currentRate">1.00 $/€</span>
            </div>
        </header>

        <main>
            <section class="card display-area">
                <div class="chart-container">
                    <canvas id="marketChart"></canvas>
                </div>
            </section>

            <section class="card controls-area">
                <!-- Task Section -->
                <div class="task-panel">
                    <div class="task-header">
                        <h3>Aufgabe <span id="taskCounter">1</span>/5</h3>
                        <button id="nextTaskBtn" class="btn-secondary">Weiter</button>
                    </div>
                    <p id="taskDescription" class="task-text">Lädt...</p>
                    <div id="taskFeedback" class="task-feedback"></div>
                </div>

                <!-- Controls -->
                <div class="control-group demand-group">
                    <h2>Nachfrage (D)</h2>
                    <p>Verschiebung der Nachfragekurve</p>
                    <div class="slider-container">
                        <label>Sinken <span>Steigen</span></label>
                        <input type="range" id="demandSlider" min="-50" max="50" value="0">
                    </div>
                </div>

                <div class="control-group supply-group">
                    <h2>Angebot (S)</h2>
                    <p>Verschiebung der Angebotskurve</p>
                    <div class="slider-container">
                        <label>Sinken <span>Steigen</span></label>
                        <input type="range" id="supplySlider" min="-50" max="50" value="0">
                    </div>
                </div>

                <div class="info-box">
                    <h3>Analyse</h3>
                    <p id="analysisText">Markt im Gleichgewicht.</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        const TASKS = [
            {
                text: "Die Europäische Zentralbank (EZB) erhöht den Leitzins überraschend stark.",
                d_dir: 1, s_dir: 0,
                explanation: "Höhere Zinsen im Euroraum machen Anlagen attraktiver. Investoren fragen mehr Euro nach (D nach rechts)."
            },
            {
                text: "US-Investoren verlieren das Vertrauen in die europäische Wirtschaft.",
                d_dir: -1, s_dir: 0,
                explanation: "Aufgrund schlechter Aussichten ziehen Investoren Kapital ab. Die Nachfrage sinkt (D nach links)."
            },
            {
                text: "Die USA erhöhen ihre Zinsen deutlich stärker als die Europäische Zentralbank.",
                d_dir: -1, s_dir: 1,
                explanation: "Dollar-Anlagen werden attraktiver. Anleger verkaufen Euro (S steigt) und fragen weniger nach (D sinkt)."
            },
            {
                text: "Europäische Unternehmen exportieren Rekordmengen in die USA.",
                d_dir: 1, s_dir: 0,
                explanation: "US-Importeure müssen Dollar in Euro tauschen. Nachfrage nach Euro steigt (D nach rechts)."
            },
            {
                text: "Europäische Touristen reisen massenhaft in den USA-Urlaub.",
                d_dir: 0, s_dir: 1,
                explanation: "Touristen tauschen Euro in Dollar. Angebot an Euro steigt (S nach rechts)."
            }
        ];

        class MarketSimulation {
            constructor() {
                this.canvas = document.getElementById('marketChart');
                this.ctx = this.canvas.getContext('2d');
                this.currentRateEl = document.getElementById('currentRate');
                this.demandSlider = document.getElementById('demandSlider');
                this.supplySlider = document.getElementById('supplySlider');
                this.analysisTextEl = document.getElementById('analysisText');
                this.taskDescEl = document.getElementById('taskDescription');
                this.taskFeedbackEl = document.getElementById('taskFeedback');
                this.nextTaskBtn = document.getElementById('nextTaskBtn');
                this.taskCounterEl = document.getElementById('taskCounter');

                this.baseDemand = 0;
                this.baseSupply = 0;
                this.currentTaskIndex = -1;
                this.taskCount = 0;

                // Safe Margins
                this.margin = { top: 60, right: 60, bottom: 60, left: 80 };

                this.resize();
                window.addEventListener('resize', () => this.resize());

                this.demandSlider.addEventListener('input', (e) => this.handleInput(e, 'd'));
                this.supplySlider.addEventListener('input', (e) => this.handleInput(e, 's'));
                this.nextTaskBtn.addEventListener('click', () => this.nextTask());

                this.nextTask();
            }

            handleInput(e, type) {
                if (type === 'd') this.baseDemand = parseInt(e.target.value);
                if (type === 's') this.baseSupply = parseInt(e.target.value);
                this.draw();
                this.checkTask();
                this.updateInfo();
            }

            resize() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.draw();
            }

            toScreenX(val) {
                const w = this.canvas.width - (this.margin.left + this.margin.right);
                return this.margin.left + (val / 120) * w;
            }

            toScreenY(val) {
                const h = this.canvas.height - (this.margin.top + this.margin.bottom);
                return this.canvas.height - this.margin.bottom - (val / 120) * h;
            }

            nextTask() {
                this.baseDemand = 0; this.baseSupply = 0;
                this.demandSlider.value = 0; this.supplySlider.value = 0;
                let newIndex;
                do { newIndex = Math.floor(Math.random() * TASKS.length); }
                while (newIndex === this.currentTaskIndex && TASKS.length > 1);

                this.currentTaskIndex = newIndex;
                this.taskCount++;
                this.taskCounterEl.textContent = ((this.taskCount - 1) % 5) + 1;

                this.taskDescEl.textContent = TASKS[this.currentTaskIndex].text;
                this.taskFeedbackEl.className = 'task-feedback';
                this.taskFeedbackEl.innerHTML = '';
                this.nextTaskBtn.textContent = "Überspringen";

                this.draw();
                this.updateInfo();
            }

            checkTask() {
                const task = TASKS[this.currentTaskIndex];
                const d = this.baseDemand;
                const s = this.baseSupply;
                const TH = 15;
                const dUser = d > TH ? 1 : (d < -TH ? -1 : 0);
                const sUser = s > TH ? 1 : (s < -TH ? -1 : 0);

                let correct = true;
                if (task.d_dir !== dUser) correct = false;
                if (task.s_dir !== sUser) correct = false;

                if (correct) {
                    this.taskFeedbackEl.innerHTML = `<strong>Richtig!</strong> ${task.explanation}`;
                    this.taskFeedbackEl.classList.add('visible', 'success');
                    this.nextTaskBtn.textContent = "Nächste Aufgabe";
                } else {
                    this.taskFeedbackEl.classList.remove('visible', 'success');
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                const d = this.baseDemand;
                const s = this.baseSupply;
                const qEq = (120 + d + s) / 2;
                const pEq = qEq - s;

                this.ctx.lineWidth = 3;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                this.drawAxes();
                this.drawStaticEquilibrium();
                this.drawSegment((q) => (120 + d) - q, '#f472b6', 'Nachfrage (D)');
                this.drawSegment((q) => q - s, '#34d399', 'Angebot (S)');

                if (qEq >= 0 && pEq >= 0) this.drawEquilibrium(qEq, pEq);

                const displayRate = Math.max(0, (1.00 + ((pEq - 60) / 120))).toFixed(2);
                this.currentRateEl.innerHTML = displayRate + " <span style='font-size:0.7em; opacity:0.7'>$/€</span>";
            }

            drawAxes() {
                this.ctx.strokeStyle = '#94a3b8';
                this.ctx.lineWidth = 1.5;
                this.ctx.beginPath();
                const x0 = this.toScreenX(0);
                const y0 = this.toScreenY(0);
                const xMax = this.toScreenX(120);
                const yMax = this.toScreenY(120);

                // Y Axis
                this.ctx.moveTo(x0, y0);
                this.ctx.lineTo(x0, yMax);
                this.ctx.lineTo(x0 - 5, yMax + 5);
                this.ctx.moveTo(x0, yMax);
                this.ctx.lineTo(x0 + 5, yMax + 5);

                // X Axis
                this.ctx.moveTo(x0, y0);
                this.ctx.lineTo(xMax, y0);
                this.ctx.lineTo(xMax - 5, y0 - 5);
                this.ctx.moveTo(xMax, y0);
                this.ctx.lineTo(xMax - 5, y0 + 5);
                this.ctx.stroke();

                this.ctx.fillStyle = '#94a3b8';
                this.ctx.font = '14px Outfit';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('$ je €', x0, this.margin.top - 25);
                this.ctx.textAlign = 'right';
                this.ctx.fillText('Menge an Euro', xMax, y0 + 35);
            }

            drawStaticEquilibrium() {
                const x = this.toScreenX(60);
                const y = this.toScreenY(60);
                this.ctx.save();
                this.ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                this.ctx.setLineDash([6, 6]);
                this.ctx.lineWidth = 1;
                this.ctx.beginPath();
                this.ctx.moveTo(this.toScreenX(0), y);
                this.ctx.lineTo(x, y);
                this.ctx.lineTo(x, this.toScreenY(0));
                this.ctx.stroke();

                this.ctx.fillStyle = '#94a3b8';
                this.ctx.textAlign = 'right';
                this.ctx.fillText('p₀', this.toScreenX(0) - 20, y + 4);
                this.ctx.textAlign = 'center';
                this.ctx.fillText('q₀', x, this.toScreenY(0) + 25);
                this.ctx.restore();
            }

            drawSegment(func, color, label) {
                this.ctx.strokeStyle = color;
                this.ctx.shadowColor = color;
                this.ctx.beginPath();
                const points = [];
                [0, 120].forEach(q => {
                    const p = func(q);
                    if (p >= 0 && p <= 120) points.push({ q, p });
                });
                const m = (func(100) - func(0)) / 100;
                if (Math.abs(m) > 0.001) {
                    const y0 = func(0);
                    const q0 = -y0 / m;
                    if (q0 > 0 && q0 < 120) points.push({ q: q0, p: 0 });
                    const qMax = (120 - y0) / m;
                    if (qMax > 0 && qMax < 120) points.push({ q: qMax, p: 120 });
                }
                points.sort((a, b) => a.q - b.q);

                if (points.length >= 2) {
                    const start = points[0];
                    const end = points[points.length - 1];
                    this.ctx.shadowBlur = 10;
                    this.ctx.moveTo(this.toScreenX(start.q), this.toScreenY(start.p));
                    this.ctx.lineTo(this.toScreenX(end.q), this.toScreenY(end.p));
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;

                    // SMART LABELING
                    this.ctx.fillStyle = color;
                    this.ctx.font = 'bold 14px Outfit';

                    const textMetrics = this.ctx.measureText(label);
                    const textWidth = textMetrics.width;

                    let lblX = this.toScreenX(end.q) + 12; // Default right of point
                    let lblY = this.toScreenY(end.p);

                    // Check if hits right border
                    // Allow 10px padding from canvas edge
                    if (lblX + textWidth > this.canvas.width - 10) {
                        lblX = this.toScreenX(end.q) - 12;
                        this.ctx.textAlign = 'right';
                    } else {
                        this.ctx.textAlign = 'left';
                    }

                    // Check top/bottom
                    lblY = Math.max(20, Math.min(this.canvas.height - 20, lblY));

                    // Outline stroke for better visibility
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeStyle = 'rgba(15, 23, 42, 0.8)';
                    this.ctx.strokeText(label, lblX, lblY);

                    this.ctx.fillText(label, lblX, lblY);
                }
            }

            drawEquilibrium(q, p) {
                const x = this.toScreenX(q);
                const y = this.toScreenY(p);
                this.ctx.save();
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.lineWidth = 1;
                this.ctx.setLineDash([4, 4]);
                this.ctx.beginPath();
                this.ctx.moveTo(this.toScreenX(0), y);
                this.ctx.lineTo(x, y);
                this.ctx.lineTo(x, this.toScreenY(0));
                this.ctx.stroke();
                this.ctx.restore();
                this.ctx.fillStyle = '#fff';
                this.ctx.beginPath();
                this.ctx.arc(x, y, 6, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.shadowColor = '#fff';
                this.ctx.shadowBlur = 15;
                this.ctx.stroke();
                this.ctx.shadowBlur = 0;
                if (Math.abs(p - 60) > 2 || Math.abs(q - 60) > 2) {
                    this.ctx.fillStyle = '#fff';
                    this.ctx.textAlign = 'right';
                    this.ctx.fillText('p₁', this.toScreenX(0) - 20, y + 4);
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('q₁', x, this.toScreenY(0) + 25);
                }
            }

            updateInfo() {
                const d = this.baseDemand;
                const s = this.baseSupply;
                let msg = "Marktstatus: ";
                if (Math.abs(d) < 5 && Math.abs(s) < 5) msg += "Ausgangsgleichgewicht (p₀, q₀).";
                else {
                    const priceChange = d - s;
                    const qtyChange = d + s;
                    let pStr = "unverändert";
                    if (priceChange > 5) pStr = "gestiegen";
                    if (priceChange < -5) pStr = "gefallen";
                    let qStr = "unverändert";
                    if (qtyChange > 5) qStr = "gestiegen";
                    if (qtyChange < -5) qStr = "gesunken";
                    msg += `Der Kurs ist ${pStr}, die Menge ist ${qStr}.`;
                }
                this.analysisTextEl.textContent = msg;
            }
        }
        document.addEventListener('DOMContentLoaded', () => new MarketSimulation());
    </script>
</body>

</html>